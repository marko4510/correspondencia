<!DOCTYPE html>
<html lang="en">

<head th:replace="layout/head :: head"></head>

<body>
  <div class="loader"></div>
  <div id="app">
    <div class="main-wrapper main-wrapper-1">
      <nav th:replace="layout/navbar :: navbar"></nav>
      <div th:replace="layout/sidebar :: sidebar"></div>

      <!-- Main Content -->
      <div class="main-content">
        <section class="section">
          <div id="tablaRegistro"></div>
        </section>
      </div>


      <footer th:replace="layout/footer :: footer">
      </footer>
    </div>
  </div>
  <div th:replace="layout/script :: script">
  </div>
  <!-- Modal Formulario -->
  <div class="modal fade modal-horaRuta" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
    aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg pullDown" style="max-width: 85%; width: 150%;">
      <div class="modal-content" id="contenidoFormularioModal">

      </div>
    </div>
  </div>

  <!-- Modal Formulario -->
  <div class="modal fade modal-horaRutaExterno" id="firstModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
    aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg pullDown" style="max-width: 85%; width: 150%;">
      <div class="modal-content" id="contenidoFormularioExternoModal">

      </div>
    </div>
  </div>

  <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalCenterTitle">Ingrese Nombre Responsable Externo</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form th:action="@{/entidadExterna/entidadExternaForm}" id="formEntidadExterna" method="post">
              <div class="modal-body">
                <div class="form-group col-md-12">
                  <input type="hidden" name="id_entidad_externa" id="id_entidad_externa">
                  <input type="text" class="form-control" id="nom_externo" name="nom_externo" required>
                  <div class="invalid-feedback">
                    Tiene que introducir el numero de una hoja de ruta
                  </div>
                </div>
              </div>
              <div class="modal-footer bg-whitesmoke br">
                <button type="submit" class="btn btn-primary">GUARDAR</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">CERRAR</button>
              </div>
            </form>
        </div>
    </div>
</div>
  <!-- Modal Ver Archivo -->
  <!-- <div class="modal fade modal-ver-documento" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" id="contenidoArchivoModal">

      </div>
    </div>
  </div> -->
  
  
  <script>
    $(document).ready(function(){
      cargarTabla();

      $('#formEntidadExterna').on('submit', function (event) {
        event.preventDefault(); // Previene el envío del formulario

        //Verifica la validez del formulario
        if (this.checkValidity() === false) {
            $(this).addClass('was-validated');
            return;
        }

        var form = $(this)[0];
        var formData = new FormData(form);

        $.ajax({
            type: 'POST',
            url: $(this).attr('action'),
            data: formData,
            contentType: false,  // No establecer el tipo de contenido aquí
            processData: false,  // No procesar los datos
            success: function (response) {
                if (response === "ok") {
                    
                    Swal.fire(
                        'Exito!',
                        'Entidad Externa Registrado con Exito!',
                        'success'
                    );
                    cargarEntidadExternos();
                    cargarTabla();
                    $('#nom_externo').val('');
                    $('#exampleModalCenter').modal('hide');
                } else {
                    Swal.fire(
                        'Imposible Registrar!',
                        response,
                        'error'
                    );
                }
            },
            error: function (xhr, status, error) {
                Swal.fire(
                    'Error!',
                    'Ocurrió un error al registrar: ' + xhr.responseText,
                    'error'
                );
            }
        });
    });
    });

    function cargarFormulari() {
      $.ajax({
        type: 'GET',
        url: "/hojaRuta/formulario",  // Ruta del metodo del controlador en Spring Boot
        success: function (response) {
          $("#contenidoFormularioModal").html(response);
          // Inicializar Select2 en el modal
          $('.select2').select2({
            dropdownParent: $('#formularioModalhojaRuta')  // Especificar el parent para el dropdown
          }); // Actualiza el contenido del div con la respuesta del servidor
        }
      });
    }
    function cargarFormulariExterno() {
      $.ajax({
        type: 'GET',
        url: "/hojaRuta/formulario_externo",  // Ruta del metodo del controlador en Spring Boot
        success: function (response) {
          $("#contenidoFormularioExternoModal").html(response);
          // Inicializar Select2 en el modal
          $('.select2').select2({
            dropdownParent: $('#formularioModalhojaRutaExterna')  // Especificar el parent para el dropdown
          }); // Actualiza el contenido del div con la respuesta del servidor
        }
      });
    }


    function cargarFormulario(id) {
      $.ajax({
        type: 'POST',
        url: "/hojaRuta/formulario/" + id,  // Ruta del metodo del controlador en Spring Boot
        success: function (response) {
          $("#contenidoFormularioModal").html(response);  // Actualiza el contenido del div con la respuesta del servidor
        }
      });
    }


    function cargarTabla() {
      $.ajax({
        type: 'POST',
        url: "/hojaRuta/tablaRegistros",  // Ruta del metodo del controlador en Spring Boot
        success: function (response) {
          $("#tablaRegistro").html(response);  // Actualiza el contenido del div con la respuesta del servidor
        }
      });
    }

    function verDocumento(id) {
      $('#contenidoFormularioModal').html(
        `<!-- Modal Header -->
<div class="modal-header">
    <h5 class="modal-title" id="myLargeModalLabel">Visualización de Documento</h5>
    <a type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </a>
</div>
<div class="modal-body">
    <embed src="/hojaRuta/verDocumento/${id}" type="application/pdf" frameborder="0" style="height: 600px; width: 100%;"></embed>
</div>
`);
    }

  </script>
</body>

</html>